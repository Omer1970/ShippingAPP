<div class="customer-profile-container" *ngIf="customer">
  <!-- Profile Header -->
  <div class="profile-header">
    <div class="header-content">
      <div class="customer-avatar">
        <mat-icon>{{ getCustomerTypeIcon(customer.customer_type) }}</mat-icon>
      </div>
      
      <div class="customer-info">
        <h1 class="customer-name">{{ customer.name }}</h1>
        <div class="customer-meta">
          <span class="customer-type">{{ customer.customer_type }}</span>
          <span class="separator">•</span>
          <mat-chip [color]="getCreditStatusColor(customer.credit_status)" class="credit-status">
            {{ customer.credit_status }}
          </mat-chip>
          <span class="separator">•</span>
          <span class="customer-level">
            <mat-chip [color]="getCustomerLevelColor(customer.classification.level)">
              {{ customer.classification.level }}
            </mat-chip>
          </span>
        </div>
      </div>
      
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="onNewOrder()">
          <mat-icon>add_shopping_cart</mat-icon>
          New Order
        </button>
        <button mat-raised-button color="accent" (click)="onNewShipment()">
          <mat-icon>local_shipping</mat-icon>
          New Shipment
        </button>
        <button mat-icon-button [matMenuTriggerFor]="headerMenu">
          <mat-icon>more_vert</mat-icon>
        </button>
        <mat-menu #headerMenu="matMenu">
          <button mat-menu-item (click)="onEditCustomer()">
            <mat-icon>edit</mat-icon>
            Edit Customer
          </button>
          <button mat-menu-item (click)="onRefreshCustomer()">
            <mat-icon>refresh</mat-icon>
            Refresh Data
          </button>
          <button mat-menu-item (click)="onBackToSearch()">
            <mat-icon>arrow_back</mat-icon>
            Back to Search
          </button>
        </mat-menu>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-state" *ngIf="isLoading">
    <mat-spinner diameter="60"></mat-spinner>
    <p class="loading-text">Loading customer profile...</p>
  </div>

  <!-- Error State -->
  <div class="error-state" *ngIf="error && !isLoading">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <h3>Profile Error</h3>
    <p class="error-message">{{ error }}</p>
    <button mat-raised-button color="primary" (click)="loadCustomerProfile()">
      <mat-icon>refresh</mat-icon>
      Retry
    </button>
  </div>

  <!-- Profile Content -->
  <div class="profile-content" *ngIf="customer && !isLoading && !error">
    <!-- Quick Stats -->
    <div class="quick-stats">
      <mat-card class="stat-card">
        <div class="stat-icon">
          <mat-icon>shopping_cart</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ statistics?.total_orders || 0 }}</div>
          <div class="stat-label">Total Orders</div>
        </div>
      </mat-card>
      
      <mat-card class="stat-card">
        <div class="stat-icon">
          <mat-icon>local_shipping</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ statistics?.total_shipments || 0 }}</div>
          <div class="stat-label">Total Shipments</div>
        </div>
      </mat-card>
      
      <mat-card class="stat-card">
        <div class="stat-icon">
          <mat-icon>attach_money</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ formatCurrency(statistics?.total_value || 0) }}</div>
          <div class="stat-label">Total Value</div>
        </div>
      </mat-card>
      
      <mat-card class="stat-card">
        <div class="stat-icon">
          <mat-icon>star</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-value">{{ getSuccessfulShipmentRate(statistics) }}</div>
          <div class="stat-label">Success Rate</div>
        </div>
      </mat-card>
    </div>

    <!-- Main Content Tabs -->
    <mat-card class="main-content">
      <mat-tab-group [(selectedIndex)]="activeTab" animationDuration="300ms">
        
        <!-- Overview Tab -->
        <mat-tab label="Overview">
          <div class="tab-content">
            <div class="overview-grid">
              <!-- Customer Details -->
              <mat-card class="detail-card">
                <mat-card-header>
                  <mat-card-title>Customer Details</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="detail-grid">
                    <div class="detail-item">
                      <span class="detail-label">Email:</span>
                      <span class="detail-value">{{ customer.email || 'N/A' }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Phone:</span>
                      <span class="detail-value">{{ customer.phone || 'N/A' }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Address:</span>
                      <span class="detail-value">{{ customer.address || 'N/A' }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Tax Number:</span>
                      <span class="detail-value">{{ customer.tax_number || 'N/A' }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Payment Terms:</span>
                      <span class="detail-value">{{ customer.payment_terms || 'N/A' }}</span>
                    </div>
                    <div class="detail-item">
                      <span class="detail-label">Preferred Delivery:</span>
                      <span class="detail-value">{{ customer.preferred_delivery_time || 'N/A' }}</span>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>

              <!-- Classification -->
              <mat-card class="detail-card">
                <mat-card-header>
                  <mat-card-title>Customer Classification</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="classification-content">
                    <div class="classification-header">
                      <mat-chip [color]="getCustomerLevelColor(customer.classification.level)" class="level-chip">
                        {{ customer.classification.level }}
                      </mat-chip>
                    </div>
                    <p class="classification-description">
                      {{ getClassificationDescription(customer.classification.level) }}
                    </p>
                    <div class="classification-benefits" *ngIf="customer.classification.benefits?.length">
                      <h4>Benefits:</h4>
                      <ul>
                        <li *ngFor="let benefit of customer.classification.benefits">{{ benefit }}</li>
                      </ul>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>

              <!-- Statistics Summary -->
              <mat-card class="detail-card">
                <mat-card-header>
                  <mat-card-title>Performance Metrics</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="metrics-grid">
                    <div class="metric-item">
                      <span class="metric-label">Average Order Value</span>
                      <span class="metric-value">{{ formatCurrency(statistics?.average_order_value || 0) }}</span>
                    </div>
                    <div class="metric-item">
                      <span class="metric-label">Active Orders</span>
                      <span class="metric-value">{{ statistics?.active_orders || 0 }}</span>
                    </div>
                    <div class="metric-item">
                      <span class="metric-label">Completed Orders</span>
                      <span class="metric-value">{{ statistics?.completed_orders || 0 }}</span>
                    </div>
                    <div class="metric-item">
                      <span class="metric-label">In Transit</span>
                      <span class="metric-value">{{ statistics?.in_transit_shipments || 0 }}</span>
                    </div>
                    <div class="metric-item">
                      <span class="metric-label">Delivered</span>
                      <span class="metric-value">{{ statistics?.delivered_shipments || 0 }}</span>
                    </div>
                    <div class="metric-item">
                      <span class="metric-label">Avg Delivery Days</span>
                      <span class="metric-value">{{ statistics?.average_days_to_deliver || 'N/A' }}</span>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </mat-tab>

        <!-- Orders Tab -->
        <mat-tab label="Orders ({{ ordersTotal }})" [badge]="ordersTotal">
          <div class="tab-content">
            <div class="orders-header">
              <h3>Order History</h3>
              <button mat-raised-button color="primary" (click)="onNewOrder()">
                <mat-icon>add_shopping_cart</mat-icon>
                New Order
              </button>
            </div>
            
            <div class="orders-table-container">
              <table mat-table [dataSource]="orders" class="orders-table">
                
                <!-- Order Reference Column -->
                <ng-container matColumnDef="ref">
                  <th mat-header-cell *matHeaderCellDef> Reference </th>
                  <td mat-cell *matCellDef="let order">
                    <a [href]="order.link" target="_blank" class="order-link">{{ order.ref }}</a>
                  </td>
                </ng-container>

                <!-- Date Column -->
                <ng-container matColumnDef="date">
                  <th mat-header-cell *matHeaderCellDef> Date </th>
                  <td mat-cell *matCellDef="let order"> {{ formatDate(order.date_commande) }} </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef> Status </th>
                  <td mat-cell *matCellDef="let order">
                    <mat-chip [color]="getOrderStatusColor(order.status)">
                      <mat-icon>{{ getOrderStatusIcon(order.status) }}</mat-icon>
                      {{ order.status }}
                    </mat-chip>
                  </td>
                </ng-container>

                <!-- Total Column -->
                <ng-container matColumnDef="total">
                  <th mat-header-cell *matHeaderCellDef> Total </th>
                  <td mat-cell *matCellDef="let order"> {{ formatCurrency(order.total_ttc) }} </td>
                </ng-container>

                <!-- Description Column -->
                <ng-container matColumnDef="description">
                  <th mat-header-cell *matHeaderCellDef> Description </th>
                  <td mat-cell *matCellDef="let order"> {{ order.description || 'N/A' }} </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['ref', 'date', 'status', 'total', 'description']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['ref', 'date', 'status', 'total', 'description'];"></tr>
              </table>

              <mat-paginator 
                [length]="ordersTotal"
                [pageSize]="ordersPerPage"
                [pageIndex]="currentOrdersPage - 1"
                (page)="onOrdersPageChange($event.pageIndex + 1)"
                showFirstLastButtons>
              </mat-paginator>
            </div>

            <div class="no-orders" *ngIf="orders.length === 0">
              <mat-icon>shopping_cart</mat-icon>
              <h4>No orders found</h4>
              <p>This customer has no order history yet.</p>
            </div>
          </div>
        </mat-tab>

        <!-- Shipments Tab -->
        <mat-tab label="Shipments ({{ shipmentsTotal }})" [badge]="shipmentsTotal">
          <div class="tab-content">
            <div class="shipments-header">
              <h3>Shipment History</h3>
              <button mat-raised-button color="accent" (click)="onNewShipment()">
                <mat-icon>local_shipping</mat-icon>
                New Shipment
              </button>
            </div>
            
            <div class="shipments-table-container">
              <table mat-table [dataSource]="shipments" class="shipments-table">
                
                <!-- Shipment Reference Column -->
                <ng-container matColumnDef="ref">
                  <th mat-header-cell *matHeaderCellDef> Reference </th>
                  <td mat-cell *matCellDef="let shipment">
                    <a [href]="shipment.link" target="_blank" class="shipment-link">{{ shipment.ref }}</a>
                  </td>
                </ng-container>

                <!-- Tracking Column -->
                <ng-container matColumnDef="tracking">
                  <th mat-header-cell *matHeaderCellDef> Tracking </th>
                  <td mat-cell *matCellDef="let shipment"> {{ shipment.tracking_number || 'N/A' }} </td>
                </ng-container>

                <!-- Status Column -->
                <ng-container matColumnDef="status">
                  <th mat-header-cell *matHeaderCellDef> Status </th>
                  <td mat-cell *matCellDef="let shipment">
                    <mat-chip [color]="getShipmentStatusColor(shipment.status)">
                      <mat-icon>{{ getShipmentStatusIcon(shipment.status) }}</mat-icon>
                      {{ shipment.status }}
                    </mat-chip>
                  </td>
                </ng-container>

                <!-- Date Column -->
                <ng-container matColumnDef="date">
                  <th mat-header-cell *matHeaderCellDef> Created </th>
                  <td mat-cell *matCellDef="let shipment"> {{ formatDate(shipment.date_creation) }} </td>
                </ng-container>

                <!-- Delivery Date Column -->
                <ng-container matColumnDef="delivery">
                  <th mat-header-cell *matHeaderCellDef> Delivery </th>
                  <td mat-cell *matCellDef="let shipment"> 
                    {{ shipment.date_delivery_planned ? formatDate(shipment.date_delivery_planned) : 'N/A' }} 
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="['ref', 'tracking', 'status', 'date', 'delivery']"></tr>
                <tr mat-row *matRowDef="let row; columns: ['ref', 'tracking', 'status', 'date', 'delivery'];"></tr>
              </table>

              <mat-paginator 
                [length]="shipmentsTotal"
                [pageSize]="shipmentsPerPage"
                [pageIndex]="currentShipmentsPage - 1"
                (page)="onShipmentsPageChange($event.pageIndex + 1)"
                showFirstLastButtons>
              </mat-paginator>
            </div>

            <div class="no-shipments" *ngIf="shipments.length === 0">
              <mat-icon>local_shipping</mat-icon>
              <h4>No shipments found</h4>
              <p>This customer has no shipment history yet.</p>
            </div>
          </div>
        </mat-tab>

        <!-- Analytics Tab -->
        <mat-tab label="Analytics">
          <div class="tab-content">
            <div class="analytics-grid">
              <!-- Order Analytics -->
              <mat-card class="analytics-card">
                <mat-card-header>
                  <mat-card-title>Order Analytics</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="analytics-content">
                    <div class="chart-placeholder">
                      <mat-icon>bar_chart</mat-icon>
                      <p>Order trend chart will be displayed here</p>
                    </div>
                    <div class="analytics-summary">
                      <div class="summary-item">
                        <span class="summary-label">Total Orders</span>
                        <span class="summary-value">{{ statistics?.total_orders || 0 }}</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Order Success Rate</span>
                        <span class="summary-value">{{ getSuccessfulShipmentRate(statistics) }}</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Average Order Value</span>
                        <span class="summary-value">{{ formatCurrency(statistics?.average_order_value || 0) }}</span>
                      </div>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>

              <!-- Shipment Analytics -->
              <mat-card class="analytics-card">
                <mat-card-header>
                  <mat-card-title>Shipment Analytics</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <div class="analytics-content">
                    <div class="chart-placeholder">
                      <mat-icon>show_chart</mat-icon>
                      <p>Shipment performance chart will be displayed here</p>
                    </div>
                    <div class="analytics-summary">
                      <div class="summary-item">
                        <span class="summary-label">Total Shipments</span>
                        <span class="summary-value">{{ statistics?.total_shipments || 0 }}</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">In Transit</span>
                        <span class="summary-value">{{ statistics?.in_transit_shipments || 0 }}</span>
                      </div>
                      <div class="summary-item">
                        <span class="summary-label">Delivered</span>
                        <span class="summary-value">{{ statistics?.delivered_shipments || 0 }}</span>
                      </div>
                    </div>
                  </div>
                </mat-card-content>
              </mat-card>
            </div>
          </div>
        </mat-tab>
      </mat-tab-group>
    </div>
  </div>
</div>