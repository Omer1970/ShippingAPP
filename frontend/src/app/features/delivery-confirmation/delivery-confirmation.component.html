<div class="delivery-confirmation-container">
  <mat-card class="delivery-card">
    <mat-card-header>
      <mat-card-title>Delivery Confirmation</mat-card-title>
      <mat-card-subtitle>Complete the delivery confirmation process</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Progress Steps -->  
      <div class="stepper-container">
        <div class="stepper-header">
          <div *ngFor="let step of steps; let i = index" 
               class="step"
               [class.completed]="isStepCompleted(i)"
               [class.active]="isStepActive(i)">
            <div class="step-icon">
              <mat-icon>{{ getStepIcon(step.key) }}</mat-icon>
            </div>
            <span class="step-label">{{ getStepLabel(step.key) }}</span>
          </div>
        </div>
        
        <div class="stepper-progress">
          <div class="progress-bar" [style.width.%]="(getCurrentStepIndex() + 1) / steps.length * 100"></div>
        </div>
      </div>

      <!-- Error Message -->
      <div *ngIf="error" class="error-message">
        <mat-icon>error</mat-icon>
        {{ error }}
      </div>

      <!-- Success Message -->
      <div *ngIf="success" class="success-message">
        <mat-icon>check_circle</mat-icon>
        Delivery confirmation completed successfully! Redirecting...
      </div>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading delivery data...</p>
      </div>

      <!-- Step Content -->
      <div *ngIf="!isLoading && !success" class="step-content">
        
        <!-- Delivery Details Step -->
        <div *ngIf="currentStep === 'details'" class="step-details">
          <h3>Delivery Information</h3>
          
          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Recipient Name *</mat-label>
              <input matInput [(ngModel)]="recipientName" placeholder="Enter recipient name">
              <mat-hint>This name will appear on the delivery note</mat-hint>
            </mat-form-field>
          </div>

          <div class="form-group">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Delivery Notes</mat-label>
              <textarea matInput [(ngModel)]="deliveryNotes" rows="3" placeholder="Optional delivery notes"></textarea>
              <mat-hint>Any special instructions or observations</mat-hint>
            </mat-form-field>
          </div>

          <div class="gps-section">
            <div class="section-header">
              <h4>GPS Location</h4>
              <button mat-raised-button color="primary" (click)="getCurrentLocation()" [disabled]="isLoading">
                <mat-icon>my_location</mat-icon>
                Get Current Location
              </button>
            </div>
            
            <div *ngIf="gpsLocation" class="gps-coordinates">
              <div class="coordinate-item">
                <mat-icon>location_on</mat-icon>
                <span>Latitude: {{ gpsLocation.latitude | number:'1.6-6' }}</span>
              </div>
              <div class="coordinate-item">
                <mat-icon>location_on</mat-icon>
                <span>Longitude: {{ gpsLocation.longitude | number:'1.6-6' }}</span>
              </div>
              <div class="coordinate-item">
                <mat-icon>precision_manufacturing</mat-icon>
                <span>Accuracy: Â±{{ gpsLocation.accuracy | number:'1.1-1' }} meters</span>
              </div>
            </div>
            
            <div *ngIf="!gpsLocation && !isLoading" class="gps-pending">
              <mat-icon>location_searching</mat-icon>
              <p>GPS location not captured yet</p>
            </div>
          </div>

          <div *ngIf="delivery" class="delivery-summary">
            <h4>Delivery Summary</h4>
            <div class="summary-item">
              <span class="label">Shipment ID:</span>
              <span class="value">#{{ shipmentId }}</span>
            </div>
            <div class="summary-item">
              <span class="label">Delivery Address:</span>
              <span class="value">{{ delivery.shipment?.address || 'Address not available' }}</span>
            </div>
          </div>
        </div>

        <!-- Signature Step -->
        <div *ngIf="currentStep === 'signature'" class="step-signature">
          <h3>Digital Signature</h3>
          <p class="step-description">Please provide a digital signature for this delivery</p>
          
          <div class="signature-guidelines">
            <mat-icon>info</mat-icon>
            <div>
              <p>Please sign clearly within the designated area</p>
              <p>Signature quality: <strong>{{ (signatureQuality * 100) | number:'1.0-0' }}%</strong></p>
            </div>
          </div>

          <div class="signature-canvas-container">
            <app-signature-canvas 
              (signatureComplete)="onSignatureComplete($event)"
              [width]="600"
              [height]="200"
              [backgroundColor]="#ffffff"
              [penColor]="#000000">
            </app-signature-canvas>
          </div>

          <div class="signature-actions">
            <button mat-stroked-button color="warn" [disabled]="!signatureData">
              <mat-icon>delete</mat-icon>
              Clear Signature
            </button>
          </div>

          <div *ngIf="signatureData" class="signature-preview">
            <h4>Preview</h4>
            <img [src]="signatureData" alt="Signature Preview">
          </div>
        </div>

        <!-- Photos Step -->
        <div *ngIf="currentStep === 'photos'" class="step-photos">
          <h3>Photo Documentation</h3>
          <p class="step-description">Attach photos for delivery confirmation</p>
          
          <div class="photo-guidelines">
            <mat-icon>photo_camera</mat-icon>
            <div>
              <p>Take photos of the delivered package at the delivery location</p>
              <small>Suggested: Package at the door, recipient if available, delivery address confirmation</small>
            </div>
          </div>

          <div class="photo-capture-container">
            <app-camera-capture
              [maxPhotos]="5"
              [allowGallery]="true"
              (photosSelected)="onPhotosSelected($event)"
              (photoUploaded)="onPhotoUploaded($event)">
            </app-camera-capture>
          </div>

          <div *ngIf="photos.length > 0" class="photo-grid">
            <div *ngFor="let photo of photos; let i = index" class="photo-item">
              <img [src]="getPhotoUrl(photo)" alt="Delivery Photo {{ i + 1 }}">
              <div class="photo-item-overlay">
                <span>Photo {{ i + 1 }}</span>
                <button mat-icon-button color="warn" (click)="removePhoto(i)">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          </div>

          <div *ngIf="photoUrls.length > 0" class="upload-status">
            <mat-icon>cloud_upload</mat-icon>
            <span>{{ photoUrls.length }} / {{ photos.length }} photos uploaded</span>
          </div>
        </div>

        <!-- Confirmation Step -->
        <div *ngIf="currentStep === 'confirm'" class="step-confirm">
          <h3>Review & Confirm</h3>
          <p class="step-description">Please review all the information before confirming delivery</p>
          
          <div class="confirmation-summary">
            <div class="summary-section">
              <h4>Delivery Information</h4>
              <div class="summary-item">
                <span class="label">Recipient:</span>
                <span class="value">{{ recipientName }}</span>
              </div>
              <div class="summary-item">
                <span class="label">Notes:</span>
                <span class="value">{{ deliveryNotes || 'No notes provided' }}</span>
              </div>
              <div class="summary-item">
                <span class="label">GPS Location:</span>
                <span class="value">
                  {{ gpsLocation?.latitude | number:'1.6-6' }}, {{ gpsLocation?.longitude | number:'1.6-6' }}
                </span>
              </div>
            </div>

            <div class="summary-section">
              <h4>Signature</h4>
              <div *ngIf="signatureData" class="signature-preview">
                <img [src]="signatureData" alt="Signature" class="signature-image">
              </div>
              <div *ngIf="!signatureData" class="no-data">
                <mat-icon>block</mat-icon>
                <span>No signature provided</span>
              </div>
            </div>

            <div class="summary-section">
              <h4>Photos</h4>
              <div *ngIf="photos.length > 0" class="photo-count">
                <mat-icon>photo_library</mat-icon>
                <span>{{ photos.length }} photo(s) will be uploaded</span>
              </div>
              <div *ngIf="photos.length === 0" class="no-data">
                <mat-icon>photo</mat-icon>
                <span>No photos attached</span>
              </div>
            </div>
          </div>

          <div class="submit-actions">
            <mat-checkbox [(ngModel)]="confirmationAcknowledged">
              I confirm that the delivery has been completed successfully
            </mat-checkbox>

            <div class="action-buttons">
              <button mat-stroked-button (click)="previousStep()">
                <mat-icon>arrow_back</mat-icon>
                Back
              </button>
              <button mat-raised-button 
                      color="primary" 
                      (click)="submitDeliveryConfirmation()"
                      [disabled]="!confirmationAcknowledged || isSubmitting"
                      [class.mat-progress-spinner]="isSubmitting">
                <mat-icon>check_circle</mat-icon>
                {{ isSubmitting ? 'Processing...' : 'Confirm Delivery' }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="step-navigation" *ngIf="!isLoading && !success">
        <button mat-stroked-button 
                (click)="previousStep()" 
                [disabled]="getCurrentStepIndex() === 0">
          <mat-icon>arrow_back</mat-icon>
          Previous
        </button>
        
        <button mat-raised-button 
                color="primary" 
                (click)="nextStep()"
                [disabled]="!canProceedToNextStep() || getCurrentStepIndex() === steps.length - 1">
          Next
          <mat-icon>arrow_forward</mat-icon>
        </button>
      </div>
    </mat-card-content>

    <!-- <mat-card-actions *ngIf="!isLoading && !success">
      <button mat-button type="button" (click)="router.navigate(['/dashboard'])">
        <mat-icon>close</mat-icon>
        Cancel
      </button>
    </mat-card-actions> -->
  </mat-card>

  <!-- Loading Overlay -->
  <div *ngIf="isUploadingPhotos" class="uploading-overlay">
    <mat-spinner diameter="60"></mat-spinner>
    <p>Uploading photos...</p>
  </div>
</div>